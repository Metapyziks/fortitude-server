<?
    var uname = post["uname"] ?? "";
    var phash = ( post["phash"] ?? "" ).ToLower();

    var hasCreds = uname.Length > 0 && phash.Length > 0;

    ErrorResponse error = null;
    if (hasCreds) {
        error = Account.AttemptLogin( uname, phash, out session );
        if (session != null) {
            response.SetCookie(new Cookie("auth-uid", session.AccountID.ToString()));
            response.SetCookie(new Cookie("auth-session", new String(session.SessionCode)));
        }
    }

	Include("parts/functions.html");
	getPageStart("Login", "http://crypto-js.googlecode.com/svn/tags/3.0.2/build/rollups/md5.js", "parts/scripts.js");
	Include("parts/header.html");
	Include ("parts/sidebar.html"); 
?>
				
		<div id = "content">
			<h1>Log in</h1>

			<? if( error != null ) { ?>
				We could not log you in :(<br />
				Reason: {$error.Message}<br /><br />
				<a href="login" >Retry</a>
			<?} 
			
			else if( session == null ) { ?>
				<p>
					Please login in with your Fortitude username and password. If you have created an account on the Fortitude app, you will be able to use the same account on the website.
				</p>
				<p>
					If you do not have an account, please sign up for one below.
				</p>
				<div style="float: left; width: 50%;">
					<h1>New Users</h1>
				</div>
				
				<div style="float: left; width: 50%;">
					<h1>Existing Users</h1>
					<form name="loginForm" action="login" method="post"
						onsubmit="if (pword.value.length > 0) phash.value = hash(pword.value); pword.value = ''">
						<input type="hidden" name="phash" />
						<table>
						<tr><td>Username:</td> <td><input type="text"     name="uname" value="{$uname}" /></td></tr>
						<tr><td>Password:</td> <td><input type="password" name="pword" /></td></tr>
						<tr><td colspan ="2">
						</td></tr>
						
						<tr><td colspan="2"><input type="submit" value="Login" /></td></tr>
						</table>
						<a href="resetpassword">Forgot your password?</a>
					</form>
				</div>
				<div style="clear: both;"></div>
			<? } 
			
			else { ?>
				<h2>Login Successful!</h2>
				You are logged in and can do stuff. <br />
			<? } ?>
		</div>
		
		<? Include ("/parts/footer.html"); ?>